<!DOCTYPE html>
<html  xml:lang="en" lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>GlassFish Wiki : 3.2CloudDeployment</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta http-equiv="content-language" content="en" />
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
        <link href="styles/docs.css" rel="stylesheet" />
        <link href="styles/site1.css" rel="stylesheet" />
        <style> a { color: #555555; } </style>
        <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
                <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>

    <body class="page-documentation project-gfmvnsite" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <div class="brand"><a href="/glassfish/index.html"><img src="../images/gflogo24.png"><span style="color:#E88A43;font-size:18px;padding-left:11px;padding-top:15px;font-weight:bold;">GlassFish</span> - <span style="font-size:18px;" class="gf-grey">World's first Java EE 7 Application Server</span></a></div>
                    <div class="nav-collapse">
                        <ul class="nav pull-right">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
									<li><a href="/glassfish/LICENSE" title="License">Legal </a></li>
									<li><a href="/glassfish/CONTRIBUTING" title="Contributing">Contributing </a></li>
                                </ul>
                            </li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <br/><br/>
        <div class="container"><body> 
 <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff"> 
  <tbody>
   <tr> 
    <td valign="top" class="pagebody">   <h4><a name="3.2CloudDeployment-SupportDeploymentinCloudEnvironment"></a>Support Deployment in Cloud Environment</h1> 
     <div> 
      <ul> 
       <li><a href="#3.2CloudDeployment-SupportDeploymentinCloudEnvironment">Support Deployment in Cloud Environment</a></li> 
       <ul> 
        <li><a href="#3.2CloudDeployment-HighLevelModelSingleDeployCommand">High Level Model - Single Deploy Command</a></li> 
        <li><a href="#3.2CloudDeployment-Supportingbothcloudandnonclouddeployments%3A%7B%7Bglassfishservices.xml%7D%7Dandvirtualizationconfiguration">Supporting both cloud and non-cloud deployments: <tt>glassfish-services.xml</tt> and virtualization configuration</a></li> 
        <ul> 
         <li><a href="#3.2CloudDeployment-Choosingthetarget">Choosing the target</a></li> 
         <li><a href="#3.2CloudDeployment-Cloudspecificmetadata">Cloud-specific metadata</a></li> 
         <li><a href="#3.2CloudDeployment-Supportinadmincommandlayerfor%7B%7B%5C%5Casync%7D%7D">Support in admin command layer for <tt>--async</tt></a></li> 
        </ul> 
        <li><a href="#3.2CloudDeployment-InteractionPointswiththeCloudEnvironment">Interaction Points with the Cloud Environment</a></li> 
        <ul> 
         <li><a href="#3.2CloudDeployment-ApplicationDeployment">Application Deployment</a></li> 
         <ul> 
          <li><a href="#3.2CloudDeployment-Orderingorchestratorandother%7B%7BDeployer%7D%7Ddelegations">Ordering orchestrator and other <tt>Deployer</tt> delegations</a></li> 
          <li><a href="#3.2CloudDeployment-Orchestratoraccesstodeploymenttimeinformation">Orchestrator access to deployment-time information</a></li> 
         </ul> 
         <li><a href="#3.2CloudDeployment-Enable">Enable</a></li> 
         <li><a href="#3.2CloudDeployment-Disable">Disable</a></li> 
         <li><a href="#3.2CloudDeployment-ApplicationUndeployment">Application Undeployment</a></li> 
         <li><a href="#3.2CloudDeployment-ApplicationRedeployment">Application Redeployment</a></li> 
        </ul> 
        <li><a href="#3.2CloudDeployment-VariousUserScenarios">Various User Scenarios</a></li> 
        <ul> 
         <li><a href="#3.2CloudDeployment-Userdeploys%2Fundeploys%2Fenables%2Fdisables%2Fredeploysanapplication%3Bnoncloudenvironment">User deploys/undeploys/enables/disables/redeploys an application; non-cloud environment</a></li> 
         <li><a href="#3.2CloudDeployment-Userdeploysanewapplication%3Bspecifiesanonexistenttarget%2Ccloudenvironment">User deploys a new application; specifies a non-existent target, cloud environment</a></li> 
         <li><a href="#3.2CloudDeployment-Userdeploysanewapplication%3Bspecifiesanexistenttarget%28orusingdefault%29%2Ccloudenvironment">User deploys a new application; specifies an existent target (or using default), cloud environment</a></li> 
         <li><a href="#3.2CloudDeployment-Userundeploysanapplication%3Bcloudenvironment">User undeploys an application; cloud environment</a></li> 
         <li><a href="#3.2CloudDeployment-Userenablesanapplication%2Ccloudenvironment">User enables an application, cloud environment</a></li> 
         <li><a href="#3.2CloudDeployment-Userdisablesanapplication%2Ccloudenvironment">User disables an application, cloud environment</a></li> 
         <li><a href="#3.2CloudDeployment-Userredeploysanapplication%3Bcloudenvironment">User redeploys an application; cloud environment</a></li> 
         <li><a href="#3.2CloudDeployment-Serverstartup">Server startup</a></li> 
         <li><a href="#3.2CloudDeployment-Servershutdown">Server shutdown</a></li> 
        </ul> 
       </ul> 
      </ul>
     </div> <h4><a name="3.2CloudDeployment-HighLevelModelSingleDeployCommand"></a>High Level Model - Single Deploy Command</h2> <p>The DAS deploy command will be the main driver during deployment of an application to the cloud. It will integrate with the cloud infrastructure by treating the orchestrator as another type of container. That is, the orchestrator will appear to deployment as a Sniffer and Deployer. (The orchestrator, as currently planned, will not make use of any general ability to intercept all asadmin commands as far as deployment, undeployment, redeployment, enable, or disable are concerned.)</p> <p>Deployment and related operations (enable, disable, undeploy, redeploy) will not be directly aware of different types of cloud implementations that might be possible. Instead such variation will be hidden behind the orchestrator's implementation of the Sniffer and Deployer interfaces (more below).</p> <p>In this document, references to "deployment" generally also include related operations such as loading or unloading an app, enabling or disabling an app, and undeploying or redeploying an app.</p> <h4><a name="3.2CloudDeployment-Supportingbothcloudandnonclouddeployments%3A%7B%7Bglassfishservices.xml%7D%7Dandvirtualizationconfiguration"></a>Supporting both cloud and non-cloud deployments: <tt>glassfish-services.xml</tt> and virtualization configuration</h2> <h4><a name="3.2CloudDeployment-Choosingthetarget"></a>Choosing the target</h3> <p>Deployment will know if it is in a cloud environment by detecting the presence of virtualization configuration. </p> <p>In a non-cloud environment, Deployment behaves as in 3.1. If the user omits the <tt>--target</tt> option then deployment uses the default "server" value. If the user specifies the target then the target must already exist and that target will be used.</p> <p>In a cloud environment, we preserve most of the above behavior with one exception: for initial deployment, user could also specify a non-existent target name and a virtual cluster will be created for the user with that name. This allows us to support the cloud deployment with minimal changes to the existing user interfaces.</p> <h4><a name="3.2CloudDeployment-Cloudspecificmetadata"></a>Cloud-specific metadata</h3> <p>Users can add <tt>glassfish-services.xml</tt> to their applications to convey cloud-related metadata. This file <tt>/META-INF/glassfish-services.xml</tt> can appear in the main application archive (EAR, WAR, etc.). It can also appear at the top level (<tt>/glassfish-services.xml</tt>) in a deployment plan, consistent with the placement of other descriptors in the deployment plan. As with all files in a deployment plan, if the user provides the same file in the original archive and in the deployment plan, the one in the deployment plan overrides the one from the archive. Specifically the orchestrator's <tt>Sniffer</tt> and <tt>Deployer</tt> implementations will see only the deployment plan copy of <tt>glassfish-services.xml</tt>.</p> <h4><a name="3.2CloudDeployment-Supportinadmincommandlayerfor%7B%7B%5C%5Casync%7D%7D"></a>Support in admin command layer for <tt>--async</tt></h3> <p>As the deployment command can be a long-running command in the cloud environment, we could add an async option to allow it to be run in async mode.</p> <p>Presumably this feature is one that could be common to several admin commands. The deploy command will take advantage of whatever common command changes are made to support async operation.</p> <h4><a name="3.2CloudDeployment-InteractionPointswiththeCloudEnvironment"></a>Interaction Points with the Cloud Environment</h2> <p>In this document, when we talk about the orchestrator we include not only the Java classes which implement the infrastructure interfaces (Sniffer, Deployer) but also any other classes and/or operating system processes and/or systems, etc. that actually provide the cloud infrastructure. As far as the deployment code is concerned those details are hidden behind the interfaces.</p> <h4><a name="3.2CloudDeployment-ApplicationDeployment"></a>Application Deployment</h3> <p>The entire deployment process for an app includes deploying the app to the DAS and then (potentially) loading the app on one or more instances.</p> <p>During the deployment-to-DAS stage, deployment asks each available Sniffer if it recognizes the archive being deployed. (The orchestrator Sniffer's <tt>handles</tt> method will check for the presence or absence virtualization configuration information, the <tt>--target</tt> option, and the presence or absence of <tt>glassfish-services.xml</tt> to make its decision)</p> <p><b>Note</b></p> 
     <ol> 
      <li>The <tt>Sniffer.handles</tt> method does not have the <tt>DeploymentContext</tt> as an argument in 3.1 which the orchestrator sniffer needs to find out the target option. As we cannot change the public <tt>Sniffer</tt> interface in 3.2 (a dot release), a private interface <tt>SmartSniffer</tt> will be added to have the additional API and orchestrator sniffer will implement this additional interface. This will be cleaned up in v4 (with the API moved to the <tt>Sniffer</tt> interface).</li> 
     </ol> <h4><a name="3.2CloudDeployment-Orderingorchestratorandother%7B%7BDeployer%7D%7Ddelegations"></a>Ordering orchestrator and other <tt>Deployer</tt> delegations</h4> <p>Deployment needs to invoke the orchestrator <tt>Deployer.prepare</tt> method before other containers' deployers. This gives the orchestrator a chance to provision and start any services that other containers' deployers need to work with. (For example, a database will need to be provisioned before the JPA <tt>Deployer.prepare</tt> can run successfully.) Similarly, the orchestrator <tt>Deployer.clean</tt> method should run after other containers' deployers. This allows other containers to finish their clean-up before the orchestrator stops or unprovisions any services that other <tt>Deployers</tt> need.</p> <p>Deployment will impose this ordering using the existing <tt>MetaData</tt> <tt>provides()</tt> and <tt>requires()</tt> mechanism.</p> <p>Further, the command framework will be enhanced so that a command that runs on the DAS and on instances can be annotated as "DAS_FIRST" or "DAS_LAST." A "DAS_FIRST" command will run to completion on the DAS and only then will run on the correct instances. A "DAS_LAST" command will run in parallel on the instances, and only when all of them have completed will the command run on the DAS.</p> <p>The <tt>DeployCommand</tt> and <tt>EnableCommand</tt> classes will be "DAS_FIRST" commands, and <tt>UndeployCommand</tt> and <tt>DisableCommand</tt> will be "DAS_LAST." Current plans call for the orchestrator to exist only on the DAS and not on instances. Using these new annotations the orchestrator <tt>Deployer.prepare</tt> method will run on the DAS before other <tt>Deployer.prepare</tt> methods run anywhere. Similarly, the orchestrator <tt>Deployer.clean</tt> method will run on the DAS but only after all other <tt>Deployer.clean</tt> methods.</p> <p>This ordering makes sure that the orchestrator can provision resources (such as databases) before those resources might be needed by other deployer's <tt>prepare</tt> methods (such as JPA), and that such resources are unprovisioned only after other deployer's <tt>clean</tt> methods have finished using them.</p> <p>(The <tt>ReDeployCommand</tt> class is DAS_FIRST although its logic is actually performed inside the <tt>DeployCommand</tt> class. Information to be preserved across the redeployment is saved early in the <tt>DeployCommand</tt> processing, then basically that code requests the command infrastructure to run the <tt>UndeployCommand</tt> which will be run as DAS_LAST processing as desired. Then the rest of the <tt>DeployCommand</tt> processing continues with DAS_FIRST semantics.)</p> <h4><a name="3.2CloudDeployment-Orchestratoraccesstodeploymenttimeinformation"></a>Orchestrator access to deployment-time information</h4> <p>The orchestrator's <tt>Deployer.prepare</tt> method has access to the deployment context which includes the DOL for the application, the name of the application, and the command parameters including a target which the user specified. The Deployer can read the DOL to identify any service references that need to be resolved and see to it that the required services are provisioned. </p> <p>The deployment context also points to the archive that is being deployed. This archive will contain, if present, the <tt>META-INF/glassfish-services.xml</tt> descriptor. The orchestrator will be able to process this file itself, using whatever parsing technique it wants. (This is consistent with how <tt>glassfish-resources.xml</tt> is handled in 3.1.) </p> <p><b>Notes:</b></p> 
     <ol> 
      <li><tt>Deployer.prepare</tt> is invoked during redeployment as well. Redeploying an app with a revised <tt>glassfish-resources.xml</tt> (or even with changes to other descriptors) could - but might not always - require the cloud to make changes in the provisioned VMs or cluster.</li> 
     </ol> <h4><a name="3.2CloudDeployment-Enable"></a>Enable</h3> <p>The enable logic invokes <tt>Deployer.prepare</tt> but with the origin set to "load" rather than "deploy." The orchestrator <tt>Deployer.prepare</tt> method will be able to distinguish between a deployment operation and an enable operation and respond accordingly.</p> <p>As a "DAS_FIRST" command, <tt>EnableCommand</tt> will execute first on the DAS. The orchestrator <tt>Deployer.prepare</tt> method can restart (not recreate) services that had been stopped as the result of an earlier disable operation before other <tt>Deployer.prepare</tt> methods - which might need those services - are invoked.</p> <h4><a name="3.2CloudDeployment-Disable"></a>Disable</h3> <p>Change from 3.1: The disable logic will need to invoke <tt>Deployer.clean</tt> but with the origin set to "unload" rather than "undeploy." This will mean retrofitting existing <tt>Deployer</tt> implementations to conform to the new semantics.</p> <p>The orchestrator can, for example, stop (but not delete) a database that is used only by the disabled application, or otherwise stop other services that will not be used while the application is disabled. As a "DAS_LAST" command, the orchestrator <tt>Deployer.clean</tt> will run on the DAS after all other <tt>Deployer.clean</tt> methods - on instances or the DAS - have finished. At that point the orchestrator can shut down (without removing) any services that will be idle now that the application that uses them is disabled.</p> <h4><a name="3.2CloudDeployment-ApplicationUndeployment"></a>Application Undeployment</h3> <p>The undeployment logic will invoke <tt>Deployer.clean</tt> (with the origin set to "undeploy") on the selected deployers so that the orchestrator's <tt>Deployer</tt> will be invoked last, just as it was invoked first during deployment. As a "DAS_LAST" command, undeployment will invoke the orchestrator <tt>Deployer.clean</tt> method last of all, so the orchestrator can unprovision any relevant services, including the virtual cluster it might have created for this application during deployment, after all other <tt>Deployers</tt> have finished their own <tt>clean</tt> processing which might require those services.</p> <h4><a name="3.2CloudDeployment-ApplicationRedeployment"></a>Application Redeployment</h3> <p>In many ways, redeployment is an undeployment followed by a deployment, but the deployment logic does several optimizations and the orchestrator will be able to as well. Redeployment is triggered if the user runs <tt>redeploy</tt> or <tt>deploy --force=true</tt> (for a previously deployed application).</p> <p>During the undeployment part of redeployment, deployment will invoke <tt>Deployer.clean</tt> for other deployers before it invokes the orchestrator's. Any <tt>Deployer</tt> implementation can use the <tt>UndeployCommandParameters.isredeploy</tt> field to distinguish between a redeployment and an undeployment. This allows the orchestrator to optimize what it does during <tt>clean</tt>, for instance to avoid unprovisioning services or VMs or the virtual cluster that the soon-to-follow deploy is likely to continue to need.</p> <p>Then, during the deployment portion of redeployment, the deployment code invokes the <tt>Deployer.prepare</tt> methods, with the orchestrator's invoked first. The deployer can use the <tt>DeployCommandParameters.isredeploy</tt> field to distinguish between a redeployment and a deployment. This allows the orchestrator to optimize what it does during <tt>prepare</tt>, for instance to avoid attempting to reprovision the existing virtual-cluster or other services used in the previous deployment.</p> <h4><a name="3.2CloudDeployment-VariousUserScenarios"></a>Various User Scenarios</h2> <h4><a name="3.2CloudDeployment-Userdeploys%2Fundeploys%2Fenables%2Fdisables%2Fredeploysanapplication%3Bnoncloudenvironment"></a>User deploys/undeploys/enables/disables/redeploys an application; non-cloud environment</h3> <p>No change from 3.1.</p> <p>Deployment uses the specified target or the default target value "server" when the target is not specified. The operation will fail if the specified target does not exist.</p> <h4><a name="3.2CloudDeployment-Userdeploysanewapplication%3Bspecifiesanonexistenttarget%2Ccloudenvironment"></a>User deploys a new application; specifies a non-existent target, cloud environment</h3> <p>The orchestrator <tt>Deployer.prepare</tt> method creates a virtual cluster with this target name, and the deployment continues. The orchestrator will additionally provision the services that are defined in the <tt>glassfish-services.xml</tt> if present.</p> <h4><a name="3.2CloudDeployment-Userdeploysanewapplication%3Bspecifiesanexistenttarget%28orusingdefault%29%2Ccloudenvironment"></a>User deploys a new application; specifies an existent target (or using default), cloud environment</h3> <p>Deployment uses the specified target or the default target value "server" when the target is not specified.</p> <p>The orchestrator <tt>Deployer.prepare</tt> method provisions the services that are defined in the <tt>glassfish-services.xml</tt> if present.</p> <h4><a name="3.2CloudDeployment-Userundeploysanapplication%3Bcloudenvironment"></a>User undeploys an application; cloud environment</h3> <p>Deployment uses the specified target or the default target value "server" when the target is not specified. The operation will fail if the specified target does not exist.</p> <p>Deployment invokes the <tt>Deployer.clean</tt> methods, invoking the orchestrator's last on the DAS. The <tt>UndeploymentCommandParameters.isredeploy</tt> value will be "false." The orchestrator <tt>Deployer.clean</tt> method unprovisions any appropriate services.</p> <h4><a name="3.2CloudDeployment-Userenablesanapplication%2Ccloudenvironment"></a>User enables an application, cloud environment</h3> <p>Deployment uses the specified target or the default target value "server" when the target is not specified. The operation will fail if the specified target does not exist.</p> <p>Deployment invokes the <tt>Deployer.prepare</tt> methods, invoking the orchestrator's first on the DAS. The origin in the deployment context has already been set to "load" so the orchestrator can distinguish between a deployment operation and an enable operation.</p> <p>The orchestrator can make sure that previously-provisioned service that might have been stopped are restarted so that they are available to the running instances of the app, once those instances are loaded on their respective hosts.</p> <h4><a name="3.2CloudDeployment-Userdisablesanapplication%2Ccloudenvironment"></a>User disables an application, cloud environment</h3> <p>Deployment uses the specified target or the default target value "server" when the target is not specified. The operation will fail if the specified target does not exist.</p> <p>Deployment will invoke the <tt>Deployer.clean</tt> methods, invoking the orchestrator's last on the DAS. The origin in the deployment context has already been set to "unload" so the orchestrator can distinguish between an undeployment operation and a disable operation. </p> <p>The orchestrator can shut down any services that the app uses which will not be needed while the app is shut down.</p> <h4><a name="3.2CloudDeployment-Userredeploysanapplication%3Bcloudenvironment"></a>User redeploys an application; cloud environment</h3> <p>Deployment uses the specified target or the default target value "server" when the target is not specified. The operation will fail if the specified target does not exist.</p> <p>Redeployment is mostly an undeployment followed by a deployment. For redeployment optimization, the orchestrator can use the <tt>UndeployCommandParameters.isredeploy</tt> field to distinguish between a redeployment and an undeployment, and use the <tt>DeployCommandParameters.isredeploy</tt> field to distinguish between a redeployment and a deployment.</p> <h4><a name="3.2CloudDeployment-Serverstartup"></a>Server startup</h3> <p>During a DAS restart, each <tt>Deployer.prepare</tt> method is invoked with the origin set to "load." The orchestrator implementation will need to differentiate between these invocations and those during enable (when the origin is also set to "load"). To do so the <tt>Deployer</tt> can check the new DeployCommandParameters.isServerStartup setting. </p> <p>Current orchestrator plans do not have the orchestrator installed on the instances so the orchestrator will not do any work during instance start up.</p> <h4><a name="3.2CloudDeployment-Servershutdown"></a>Server shutdown</h3> <p>During a DAS shutdown, the infrastructure will invoke <tt>Deployer.clean</tt>. The orchestrator might not need to know about a DAS shutdown anyway because other instances which host the app might still be running. The orchestrator would not be able to stop a database or some other type of service which the other running instances of the app would need. Even so, any <tt>Deployer</tt> will be able to check UndeployCommandParameters.isServerShutdown to see if a server shutdown is in progress vs. the app being disabled.</p> <p>Current orchestrator plans do not have the orchestrator installed on the instances so the orchestrator will not do any work during instance shutdown.</p> </td> 
   </tr> 
  </tbody>
 </table>    
</body></div>
        <br/>

        <!-- footer================================================== -->
        <footer class="well">
            <div class="container">

                <div class="row-fluid" id="bottom-info">
                    <!--div class="span6 pagination-centered" id="social"-->
                    <div class="span4" id="social">			
                        <a href="http://blogs.oracle.com/theaquarium/"><img src="../images/icons/TheAquarium.png"></a>
                        <a href="https://twitter.com/glassfish"><img src="../images/icons/twitter.png"></a>
                        <a href="https://plus.google.com/communities/106098646151660933759"><img src="../images/icons/google.png"></a>
                        <a href="http://www.linkedin.com/groups/GlassFish-Users-106819/about"><img src="../images/icons/linkedin.png"></a>
                        <a href="http://www.youtube.com/user/GlassFishVideos"><img src="../images/icons/youtube.png"></a>
                        <a href="https://www.facebook.com/GlassFish"><img src="../images/icons/facebook.png"></a>
                    </div>

                    <div class="span8" id="copyright">Page last changed on May 18, 2011 by 
<font color="#0050B2">hong.zhang</font>. Exported from wikis.oracle.com on May 27, 2015 20:43.<br/>
                        Copyright &copy; 2005-2015 Oracle Corporation and/or its affiliates.</div>
                </div>
            </div>
        </footer>

        <!-- ================================================== -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/bootstrap-tab.js"></script>
	<script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<!--  Begin SiteCatalyst code  -->
  	<!--  End SiteCatalyst code  -->
    </body>
</html>