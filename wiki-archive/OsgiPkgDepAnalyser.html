<!DOCTYPE html>
<html  xml:lang="en" lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>GlassFish Wiki : OsgiPkgDepAnalyser</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta http-equiv="content-language" content="en" />
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
        <link href="styles/docs.css" rel="stylesheet" />
        <link href="styles/site1.css" rel="stylesheet" />
        <style> a { color: #555555; } </style>
        <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
                <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>

    <body class="page-documentation project-gfmvnsite" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <div class="brand"><a href="/glassfish/index.html"><img src="../images/gflogo24.png"><span style="color:#E88A43;font-size:18px;padding-left:11px;padding-top:15px;font-weight:bold;">GlassFish</span> - <span style="font-size:18px;" class="gf-grey">World's first Java EE 7 Application Server</span></a></div>
                    <div class="nav-collapse">
                        <ul class="nav pull-right">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
									<li><a href="/glassfish/LICENSE" title="License">Legal </a></li>
									<li><a href="/glassfish/CONTRIBUTING" title="Contributing">Contributing </a></li>
                                </ul>
                            </li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <br/><br/>
        <div class="container"><body> 
 <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff"> 
  <tbody>
   <tr> 
    <td valign="top" class="pagebody">   <p><b>Introduction:</b></p> <p>This is a light weight tool developed in leisure time to analyse OSGi metadata of various bundles in a glassfish distribution. If you have questions, comments, please contact Sahoo &amp; Siva.</p> <p>Given below is a snapshot of the report generated by the tool against GlassFish 4.0 trunk (SVN revision : 55315) .</p> <p><b>GROSS STATISTICS&nbsp;</b></p> <p>Total number of bundles in this repository: 275</p> <p>Total number of wires = 6393</p> <p>Total number of exported packages = 2252</p> <p>Total number of duplicate-packages = 13</p> <p>Total number of unused-packages = 1281</p> <p><b>Detailed Report</b></p> <p>For details, refer to the individual files mentioned below:</p> <p>1) <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679745.pdf">bundles.xml</a>: For each bundle, it contains symbolic name, exported package details and imported package details. Exported packages are further divided into two segments: used and unused. If an exported package is not imported by any other module than the exporter, it is considered an unused package.</p> <p>2) <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679746.pdf">duplicate.txt</a>: Contains packages that are duplicated in various bundles.</p> <p>3) <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679748.pdf">wires.xml</a>: Tries to match importers with exporters. There is a wires.xsl as well. So, if you open this file in a browser, you will get a nice tabular report. The wiring details may not be totally correct, because I just try to match package names without considering version constraint or attribute matching.</p> <p>4) <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679747.pdf">unused.txt</a>: Contains list of exported packages that are never imported by anyone other the exporting bundle. We have quite a large number of such packages (do a wc on the file to know the number). As I write, almost two thirds of our exported packages are unused.</p> <p><b>What are the issues</b></p> <p>0) Too many wires (i.e., dependencies among modules)<br> Our bundles are too tightly coupled. Good quality modules need to be loosely coupled and highly cohesive.</p> <p>1) Too many unused packages</p> <p>Each module owner has to update either osgi.bundle or pom.xml or some other configuration file as per their build environment to remove unnecessary packages being exported. Look at the &lt;used&gt; segment in bundles.xml file to find out which packages are really needed as per OSGi package metadata.</p> <p>2) Some bundles export package without any version</p> <p>The following command will show all such packages:</p> <p>grep version=0.0.0 bundles.xml</p> <p>It is OK to export packages with no version if you really don't know what should be the version of the package. Except for javax APIs, I don't see any reason for not specifying a version while exporting a package. For javax packages, it is a bigger problem and attempts are being made to standardise their OSGi version numbers.</p> <p>3) Some bundles import without any version range</p> <p>The following command will show all such packages:</p> <p>grep "0.0.0, infinity" bundles.xml</p> <p>The result will include JRE packages as well, so module owners have to look at it more carefully. e.g., metro imports jax-ws like this, which is clearly wrong, because metro needs jax-ws 2.1.2. It can lead to bugs. See issue #</p> <p>4) Duplicate packages</p> <p>Same package appears in multiple bundles. Unless there is a good reason to do so, avoid it.</p> <p><b>Exception List</b></p> <p>The tool will be modified to accept an exception list, because there are some packages which are needed to be exported even though they are not imported by any module in modules/. Instead those packages are either expected to be imported by some foreign bundles or imported via DynamicImport-Package mechanism (typically by application class loader). e.g., some of the EJB container APIs are needed to be exported because the generated EJB classes refer to them. Same is true for jsp container as well. Module owners are expected to update this <a href="Exceptionlist.html" title="Exceptionlist">Exceptionlist</a> so that when the tool is capable of accepting such a list, it will not report them as something to take care of.</p> <p><b>How to generate the report yourself:</b></p> 
     <div class="code panel" style="border-width: 1px;">
      <div class="codeContent panelContent"> 
       <div id="root"> 
        <pre class="theme: Confluence; brush: java; gutter: false">svn co https://svn.java.net/svn/hk2~svn/trunk/hk2/

cd ./hk2/dependency-verifier/

mvn clean install

./run-package-analyser.sh path-to-glassfish-modules-directory bundles.xml wires.xml duplicate.txt unused.txt</pre> 
       </div> 
      </div>
     </div> <p><b>Maven Plugin</b></p> <p>The tool is already part of hk2-maven-plugin. The goal name is analyse-packages. To invoke the maven plugin, you need to use one of the distribution (e.g., nucleus/web/glassfish) pom.xml. e.g.,</p> 
     <div class="code panel" style="border-width: 1px;">
      <div class="codeContent panelContent"> 
       <div id="root"> 
        <pre class="theme: Confluence; brush: java; gutter: false">mvn -f main/appserver/distributions/glassfish/pom.xml hk2:analyse-packages</pre> 
       </div> 
      </div>
     </div> <p>Once we integrate HK2 version 1.0.13 in v3, the -D properties in the above command will not be needed.</p> <p>Currently the maven plugin has some limitations. I am working on it.</p> <p><b>Associated bugs:</b></p> <p>See <a href="https://github.com/javaee/glassfish/issues/11782">issue 11782</a> and its dependencies.</p> <p><b>TODO</b></p> <p>1. Accept an exception list (Thanks to Tim for bringing it up).</p> <p>2. Change the maven plugin to generate reports similar to command line utility.</p> <p>3. Change the maven plugin to analyse bundles that are actually distributed. Currently the maven plugin analyses all bundles that are part of the maven project.</p> <p>Author:</p> <p><b>Comments/Suggestions</b></p> <p>If you have any comments or suggestions about this page or the tool, please contact me (Sahoo).</p> <br> 
     <div class="tabletitle"> 
      <a name="attachments"> <h4>Attachments:</h2> </a> 
     </div> 
     <div class="greybox" align="left"> 
      <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""> 
      <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679745.pdf">Bundles.html.pdf</a> (application/pdf) 
      <br> 
      <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""> 
      <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679746.pdf">duplicate.pdf</a> (application/pdf) 
      <br> 
      <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""> 
      <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679747.pdf">unused.pdf</a> (application/pdf) 
      <br> 
      <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""> 
      <a href="http://download.java.net/glassfish/wiki-archive/attachments/20874896/43679748.pdf">wires.html.pdf</a> (application/pdf) 
      <br> 
     </div> </td> 
   </tr> 
  </tbody>
 </table>    
</body></div>
        <br/>

        <!-- footer================================================== -->
        <footer class="well">
            <div class="container">

                <div class="row-fluid" id="bottom-info">
                    <!--div class="span6 pagination-centered" id="social"-->
                    <div class="span4" id="social">			
                        <a href="http://blogs.oracle.com/theaquarium/"><img src="../images/icons/TheAquarium.png"></a>
                        <a href="https://twitter.com/glassfish"><img src="../images/icons/twitter.png"></a>
                        <a href="https://plus.google.com/communities/106098646151660933759"><img src="../images/icons/google.png"></a>
                        <a href="http://www.linkedin.com/groups/GlassFish-Users-106819/about"><img src="../images/icons/linkedin.png"></a>
                        <a href="http://www.youtube.com/user/GlassFishVideos"><img src="../images/icons/youtube.png"></a>
                        <a href="https://www.facebook.com/GlassFish"><img src="../images/icons/facebook.png"></a>
                    </div>

                    <div class="span8" id="copyright">Page last changed on Aug 06, 2012 by 
<font color="#0050B2">16468</font>. Exported from wikis.oracle.com on May 27, 2015 20:46.<br/>
                        Copyright &copy; 2005-2015 Oracle Corporation and/or its affiliates.</div>
                </div>
            </div>
        </footer>

        <!-- ================================================== -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/bootstrap-tab.js"></script>
	<script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<!--  Begin SiteCatalyst code  -->
  	<!--  End SiteCatalyst code  -->
    </body>
</html>