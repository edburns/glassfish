<!DOCTYPE html>
<html  xml:lang="en" lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>GlassFish Wiki : GlassFish_v3.1_GMS_One_Pager</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="" />
        <meta http-equiv="content-language" content="en" />
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
        <link href="styles/docs.css" rel="stylesheet" />
        <link href="styles/site1.css" rel="stylesheet" />
        <style> a { color: #555555; } </style>
        <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
                <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    </head>

    <body class="page-documentation project-gfmvnsite" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <div class="brand"><a href="/glassfish/index.html"><img src="../images/gflogo24.png"><span style="color:#E88A43;font-size:18px;padding-left:11px;padding-top:15px;font-weight:bold;">GlassFish</span> - <span style="font-size:18px;" class="gf-grey">World's first Java EE 7 Application Server</span></a></div>
                    <div class="nav-collapse">
                        <ul class="nav pull-right">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                                <ul class="dropdown-menu">
									<li><a href="/glassfish/LICENSE" title="License">Legal </a></li>
									<li><a href="/glassfish/CONTRIBUTING" title="Contributing">Contributing </a></li>
                                </ul>
                            </li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <br/><br/>
        <div class="container"><body> 
 <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff"> 
  <tbody>
   <tr> 
    <td valign="top" class="pagebody">   <h4><a name="GlassFish_v3.1_GMS_One_Pager-DynamicRuntimeClusteringinGlassfishv3.1usingShoalGroupManagementService"></a>Dynamic Runtime Clustering in Glassfish v3.1 using Shoal Group Management Service</h2> <p>One pager template version: 1.9</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-1.Introduction"></a>1. Introduction</h4> <h4><a name="GlassFish_v3.1_GMS_One_Pager-1.1.Project%2FComponentWorkingName%3A"></a>1.1. Project/Component Working Name:</h4> <p>Dynamic Runtime Clustering Support via Shoal Group Management Service</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-1.2.Name%28s%29andemailaddressofDocumentAuthor%28s%29%2FSupplier%3A"></a>1.2. Name(s) and e-mail address of Document Author(s)/Supplier:</h4> <p>Name: jfialli@java.net<br> Name: bbissett@java.net</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-1.3.DateofThisDocument%3A"></a>1.3. Date of This Document:</h4> <p>07/13/2010 incorporate changes to 4.5 interfaces for AliveAndReadyCoreView management.<br> 06/30/2010 incorporate changes 4.5 Interfaces changes to complete implementing split of shoal-gms into shoal-gms-api and shoal-gms-impl jars.<br> Updated GroupManagementServer.getPreviousAliveAndReady() based on design discussion with Mahesh.<br> 06/11/2010 updated access to GMS within GF v3.1 after design session with Jerome<br> 06/02/2010 updated based on Mahesh's feedback<br> 05/24/2010</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-2.ProjectSummary"></a>2. Project Summary</h4> <h4><a name="GlassFish_v3.1_GMS_One_Pager-2.1.ProjectDescription%3A"></a>2.1. Project Description:</h4> <p>Integrating Shoal Group Management Service into a Glassfish cluster allows</p> 
     <ul> 
      <li>other Glassfish application services to register for notification of other clustered instances joining and leaving<br> (normal and abnormal termination) the glassfish cluster</li> 
      <li>get the current member status of any member in the cluster.</li> 
      <li>sending a message to one, some or all clustered instances in the cluster</li> 
      <li>get a list of Core or All clustered instances in the glassfish cluster.</li> 
     </ul> <h4><a name="GlassFish_v3.1_GMS_One_Pager-2.2.RisksandAssumptions%3A"></a>2.2. Risks and Assumptions:</h4> <p>Miss reporting GMS FAILURE notification on fast restart(instance restarted faster than GMS default heartbeat failure detection configuration)<br> due to no NodeAgent in GF v3.1. See details in section 4.12 discussion on how application is notified of missed GMS<br> notification of FAILURE due to fast restart. If GF v3.1, a clustered instance could be restarted faster than<br> GMS heartbeat failure detection time due to clustered instance being a registered native OS service that is automatically<br> restarted when the native OS detects that the service has failed.</p> <p>Metro Reliable Messaging(RM) HA requires larger payloads than GMS messaging supported in past releases.<br> For session data, payloads were only in the range of 2k to 10k. For Metro Reliable Messaging RM,<br> the message payload size is application dependent and can range significantly in value.<br> We are evaluating larger message payloads for GMS sendMessage in Shoal GMS distributed unit level<br> testing now to limit future risk. We are working with Metro RM team to identify a ballpark range of size and msg<br> throughput.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-3.ProblemSummary"></a>3. Problem Summary</h4> <h4><a name="GlassFish_v3.1_GMS_One_Pager-3.1.ProblemArea%3A"></a>3.1. Problem Area:</h4> <p>GMS provides infrastructure to build fault tolerance, reliability and availability within a glassfish cluster.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-3.2.Justification%3A"></a>3.2. Justification:</h4> <p>High availability of session data in a glassfish cluster is a release driver for v3.1 and the<br> High availability of session data(i.e., http sessions, stateful ejb) is built on top of GMS subsystem.<br> The GMS subsystem provides high availability module with the ability to send messages within the cluster and<br> the ability to compute a consistent hash based on the clustered CORE instances that are currently running.</p> <p>Other cluster services using GMS include IIOP, IIOP load balancer, EJB timer migration, delegated transaction recovery, Metro RM.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.TechnicalDescription%3A"></a>4. Technical Description:</h4> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.1.Details%3A"></a>4.1. Details:</h4> <p>Shoal GMS over JXTA transport was used by high availability in Glassfish v2.x.<br> For Glassfish v3.1, Shoal GMS over Grizzly transport is going to be used.<br> The motivation for changing from jxta transport to grizzly transport were numerous.<br> Grizzly is already part of the Glassfish v3. Grizzly is actively being optimized and<br> further developed. The Grizzly developers are part of Glassfish development and<br> are able to provide support for the transport.</p> <p>We have done Shoal GMS unit testing to verify that Shoal GMS over Grizzly is as predictable and<br> performant or higher performing than Shoal GMS over JXTA. These Shoal GMS unit test include<br> message sending throughput and validating GMS notifications are working as well with<br> Shoal over Grizzly as it does with Shoal over Jxta in past.</p> <p>We have written distributed Shoal GMS unit test to simulate HA messaging patterns and throughput.<br> This allowed us to validate that Shoal GMS messaging is sufficient for HA needs.</p> <p>When does an application server instance joins a GMS group.<br> 1. When a clustered instance belongs to a cluster with gms-enabled with a value of true, the clustered instance<br> joins the cluster when cluster instance is started.<br> (see <a href="http://wiki.glassfish.java.net/attach/V3FunctionalSpecs/gmsconfig_gfv3_1.rtf">http://wiki.glassfish.java.net/attach/V3FunctionalSpecs/gmsconfig_gfv3_1.rtf</a> for more on<br> specification of domain.xml element cluster attribute gms-enabled).</p> <p>2. When a DAS is started, it joins each of its cluster that has gms-enabled with a value of true.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.2.Bug%2FRFENumber%28s%29%3A"></a>4.2. Bug/RFE Number(s):</h4> <p>// List any Bug(s)/RFE(s) which will be addressed by this proposed change.<br> // Provide links to the Bug(s)/RFE(s)where possible.<br> // RFE's must be trackable via an issue in Issue Tracker for<br> // features in the open source distro and in Bugster for value-add<br> // features to be released in the commercial distro.</p> <p>TBD: Will enter Milestone Features listed in <a href="./GlassFishv3GMS.html">http://wiki.glassfish.java.net/Wiki.jsp?page=GlassFishv3GMS</a> into issue tracker and reference them.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.3.InScope%3A"></a>4.3. In Scope:</h4> <p>// Aspects that are in scope of this proposal if not obvious from above.<br> Support for clustered instances of a glassfish cluster are required to be on same subnet and multicast needs<br> to be enabled for the subnet on each machine and router connecting the machines. This requirement was required<br> in glassfish v2.1.1.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.4.OutofScope%3A"></a>4.4. Out of Scope:</h4> <p>// Aspects that are out of scope if not obvious from above.<br> Virtual Multicast Support (substitute UDP broadcast with a static list of IP Addresses and ports).</p> <p>Missed FAILURE notifications due to quick restart of a failed clustered instance.<br> In gf v2.1.1 the Nodeagent notified GMS (via GMS watchdog failure notification) when it was<br> going to restart an instance. Since there is no NodeAgent in GF v3.1, this is no longer possible.<br> See details of how this worked in GF v2.1 in following document: <a href="http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc">http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc</a><br> The REJOIN subevent described in section 4.5.1 addresses how a GMS client will be notified<br> of missed GMS notifications of FAILURE when a clustered instance is restarted very quickly.<br> GMS client is responsible for checking for REJOIN subevent on JOIN and JOINED_AND_READY events<br> as a means to detect fast restart of clustered instance.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.5.Interfaces%3A"></a>4.5. Interfaces:</h4> <p>// Interfaces may be commands, files, directory structure, ports,<br> // DTD/Schema, tools, APIs, CLIs, etc.<br> // Note: In lieu of listing the interfaces in the one pager, providing<br> // a link to another specification which defines the interfaces<br> // is acceptable.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.5.1.PublicInterfaces"></a>4.5.1. Public Interfaces</h4> <p>An EJB or web tier application attains access to GMS via GMSFactory.getModule().</p> <p>******************</p> <p>GF v3.1 modules access GMS via following api,</p> <p>// List new, public interfaces this project exports.<br> Module glassfish/v3/cluster/gms-bootstrap depends on shoal-gms-api.jar only.</p> <p>@Service<br> class GMSAdapterService // loads gms-adapter module only if gms-enabled.</p> <p>/**</p> 
     <ul> 
      <li>Return the GMSAdapter for a clustered instance in a cluster with gms-enabled is true.</li> 
      <li>Works in DAS with one cluster.</li> 
      <li>Throws IllegalStateException if called when DAS has multiple clusters. Use getGMSAdapterByName(String) when in DAS specific code.<br> */<br> GMSAdapter getGMSAdapter();</li> 
     </ul> <p>/**</p> 
     <ul> 
      <li>Return the GMSAdapter for a cluster named "clusterName" with gms-enabled is true.</li> 
      <li>Strongly recommend using this method in DAS specific code since DAS can have more than one cluster.</li> 
      <li>A clustered instance can belong to one and only one glassfish cluster.<br> */<br> GMSAdapter getGMSAdapterByName(String clusterName); // must be used in DAS when it has multiple clusters.</li> 
     </ul> <p>boolean isGmsEnabled();</p> <p>Module glassfish/v3/gms-adapter</p> <p>import com.sun.enterprise.ee.cms.core.CallBack;</p> <p>@Contract<br> interface GMSAdapter </p> 
     <div class="error">
      <span class="error">Unknown macro: { /** Get implementation of GroupManagementServicefrom Shoal GMS API module needs to add dependency on shoal-gms-api-1.5.3(or higher).jar * @returns GroupManagementService. */ GroupManagementService getModule(); String getClusterName(); // use the following methods in GF v3.1 rather than GroupManagementService.addActionFactory(...) // The default client implementations of ActionFactoryImpl are not in shoal-gms-api*.jar. void registerJoinNotificationListener(CallBack callback); void registerJoinedAndReadyNotificationListener(CallBack callback); void registerMemberLeavingListener(CallBack callback); void registerPlannedShutdownListener(CallBack callback); void registerFailureSuspectedListener(CallBack callback); void registerFailureNotificationListener(CallBack callback); void registerFailureRecoveryListener(String componentName, CallBack callback); void registerMessageListener(String componentName, CallBack messageListener); void registerGroupLeadershipNotificationListener(CallBack callback); // use the following methods rather than GroupManagmentServer.removeActionFactory(...) void removeFailureRecoveryListener(String componentName); void removeMessageListener(String componentName); void removeFailureNotificationListener(CallBack callback); void removeFailureSuspectedListener(CallBack callback); void removeJoinNotificationListener(CallBack callback); void removeJoinedAndReadyNotificationListener(CallBack callback); void removePlannedShutdownListener(CallBack callback); void removeGroupLeadershipLNotificationistener(CallBack callback); void removeMemberLeavingListener(CallBack callback); }</span> 
     </div> <p>Other modules in Glassfish V3.1 that require access to GMS can access it in following way:</p> <p>GMS Client access to GMSService in clustered instance and in DAS with only one cluster.<br> import org.glassfish.gms.GMSAdapter;<br> import org.glassfish.gms.bootstrap.GMSAdapterService;<br> @Inject<br> GMSAdapterService gmsAdapterService;<br> GroupMangementService gms;</p> <p>postConstruct() {<br> if (gmsAdapterService.isGmsEnabled()) </p> 
     <div class="error">
      <span class="error">Unknown macro: { gms = gmsAdapterService.getGmsAdapter().getModule(); }</span> 
     </div> <p>}</p> <p>Add methods to existing Shoal GMS class com.sun.enterprise.ee.cms.core.GroupHandle</p> <p>/**</p> 
     <ul> 
      <li>This snapshot was terminated by AliveAndReadyView.getSignal(), a GMS notification of</li> 
      <li>either JoinedAndReadyNotificationSignal, FailureNotificationSignal or PlannedShutdownSignal.<br> *</li> 
      <li>&lt;p&gt;</li> 
      <li>Behavior is not well defined at during GROUP_STARTUP or GROUP_SHUTDOWN.<br> *</li> 
      <li>&lt;p&gt;</li> 
      <li>If the last GMS notification was a JOIN with a REJOIN subevent, the list previous CORE members will be same as list of current CORE members.</li> 
      <li>(this scenario reflects a fast restart of an instance in less than GMS heartbeat failure detection can detect failure, this is called a REJOIN</li> 
      <li>when an instance fails and restarts so quickly that FAILURE_NOTIFICATION is never sent. THe REJOIN subevent represents the unreported FAILURE</li> 
      <li>detected at the time that the instance is restarting.)<br> *<br> *</li> 
      <li>@return the previous AliveAndReady Core member snapshot<br> */<br> AliveAndReadyView getPreviousAliveAndReadyCoreView(); // to be used by HA module</li> 
     </ul> <p>/**</p> 
     <ul> 
      <li>Get a current snapshot of the AliveAndReady Core members.</li> 
      <li>AliveAndReadyView.getSignal() returns null to signify that</li> 
      <li>the view is still the current view and no GMS notification signal</li> 
      <li>has terminated this current view yet.<br> *</li> 
      <li>@return current view of AliveAndReady Core members<br> */<br> AliveAndReadyView getCurrentAliveAndReadyCoreView();</li> 
     </ul> <p>********</p> <p>new Interface AliveAndReadyView for package com.sun.enterprise.ee.cms.core;</p> <p>/**</p> 
     <ul> 
      <li>A read-only view consisting of all the AliveAndReady CORE members of a GMS group.<br> *</li> 
      <li>The GMS notification signals of JoinedAndReadyNotificationSignal, FailureNotificationSignal and PlannedShutdownSignal</li> 
      <li>transition from one of these views to the next view. When one of these signal occurs, the current view is terminated</li> 
      <li>by setting its signal. While the view's signal is null, it is considered the current view. Once a terminating signal</li> 
      <li>occurs, than this view is considered the previous view and getSignal() returns the GMS notification that caused this</li> 
      <li>view to conclude.<br> */<br> public interface AliveAndReadyView 
       <div class="error">
        <span class="error">Unknown macro: { /** * These are members of this view BEFORE the GMS notification signal that terminated * this view as being the current view. * * @return an unmodifiable list of sorted CORE members who are alive and ready. * */ SortedSet&lt;String&gt; getMembers(); /** * * @return signal that caused transition from this view. returns null when this is the current view * and no signal has occurred to cause a transition to the next view. */ Signal getSignal(); /** * * @return time this view ceased being the current view when its signal was set. */ long getSignalTime(); /** * Monotonically increasing id. Each GMS notification signal for a core member that causes a new view to be created * results in this value being increased. * @return a generated id */ long getViewId(); /** * @return duration in milliseconds that this view is/was the current view. * If &lt;code&gt;getSignal&lt;/code&gt; is null, this value is still growing each time this method is called. */ long getViewDuration(); /* * @return time that this view got created. */ long getViewCreationTime(); }</span> 
       </div></li> 
     </ul> <p>*********<br> The following functionality is only necessary when gms group members are restarted immediately after a software failure.<br> This functionality is needed in Glassfish v3.1 since there will be a local machine mechanism where a failed<br> clustered instance will be automatically restarted (registered as a native OS service).</p> <p>Add interface for Rejoin subevent to GMS Join and JoinedAndReady Notificiation signal.</p> <p>Add interface com.sun.enterprise.ee.cms.core.RejoinSubevent.</p> <p>/**</p> 
     <ul> 
      <li>Representation of a missed FAILURE notification when restarting an instance.<br> */<br> interface RejoinSubevent 
       <div class="error">
        <span class="error">Unknown macro: { // time that the failed instance instantiation joined the group. long getGroupJoinTime(); }</span> 
       </div></li> 
     </ul> <p>interface RejoinableEvent </p> 
     <div class="error">
      <span class="error">Unknown macro: { // Returns RejoinSubevent if this Join or JoinedAndReady notification is for an instance that restarted quicker // than GMS heartbeat failure detection was able to report the GMS notification FAILURE. // Returns NULL if this instance is not restarting without gms group being notified that it had left group in past. RejoinSubevent getRejoinSubevent(); }</span> 
     </div> <p>Existing com.sun.enterprise.ee.cms.core JoinNotificationSignal and JoinedAndReadyNotificationSignal will implement RejoinableEvent.</p> <p>We were able to avoid adding this functionality in Glassfish v2.1.1 due to technique described in this<br> document: <a href="http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc">http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc</a>.</p> <p>Rationale on why GMS did not just issue a FAILURE notification followed by a Join notification when an instance restarted faster than<br> GMS heartbeat failure detection could detect the instance failed. This rationale justifies why REJOIN is being introduced.</p> 
     <ul class="alternate" type="square"> 
      <li>When a fast restart occurs, GMS notices that a new instantiation of a member has started and GMS still had a reference to the<br> previously failed instance. At this point in time, if one calls GroupHandle.getMemberStatus() on the restarted instance, one would<br> get the response that it was alive. So it was considered too late to send a FAILURE notification for a member when it already had<br> restarted. The REJOIN subevent on JOIN and JOINED_AND_READY GMS notifications was the chosen way to indicate to the application<br> that a previous instantiation of member had FAILED while a new instantiation of the member is JOIN'ing the cluster.</li> 
     </ul> <p>Detail description of the fast restart is described in Section 3.1 of <a href="http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.pdf">http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.pdf</a>.<br> The REJOIN subevent indicates that an instantiation of the instance that joined the cluster at a certain time in the past has failed.<br> The REJOIN subevent has the time the previous instantiation of member had joined the cluster. The Shoal GMS log events also report<br> that no FAILURE event was sent for the FAST RESTART of the member. The actual log events are in gmsWatchdog.pdf referenced above.</p> <p>*********</p> <p>Mahesh's review requested this functionality. Below are my initial thoughts. Need assistance on next steps.</p> <p>TBD: Add a capability for GMS notification callback handlers to be found by hk2 and automatically registered.<br> Require assistance of someone who understands hk2 on what impact this has on gms-adapter implementation</p> <p>We will either need to add an annotation to the callbacks or potentially introduce marker Callback interfaces for each<br> GMS notification in GMS. (i.e. a JoinCallback that extends com.sun.enterprise.ee.cms.core.Callback, one for JoinedAndReady, and so on.)<br> Currently, there is only one generic Callback for all GMS notifications, com.sun.enterprise.ee.cms.core.Callback.<br> The developer implements an implementation of this callback which contains a processNotification(Signal).<br> The current API allows a Callback to be registered for one or more GMS notifications.</p> <p>The following lines are used to specify which GMS notifications callbacks should be called for.<br> Notice that there are two distinctly different coding patterns that a Shoal GMS developer may use<br> when writing Shoal GMS callbacks.</p> <p>In Shoal GMS test HAMessageReplicationSimulator.java, there is one callback per notification type.</p> <p>gms.addActionFactory(new JoinNotificationActionFactoryImpl(new JoinNotificationCallBack()));<br> gms.addActionFactory(new JoinedAndReadyNotificationActionFactoryImpl(new JoinAndReadyNotificationCallBack(memberID)));<br> gms.addActionFactory(new MessageActionFactoryImpl(new MessageCallBack(memberID)), "TestComponent");</p> <p>While in Shoal GMS test ApplicationServer and GMSClientService "simulation", there is only one callback implementation registered<br> with many different GMS notification callbacks.</p> <p>class GMSClientService implements com.sun.enterprise.ee.cms.core.Callback {<br> public GMSClientService(final String serviceName, final String memberToken){<br> gms = GMSFactory.getGMSModule();<br> gms.addActionFactory(new PlannedShutdownActionFactoryImpl(this));<br> gms.addActionFactory(new JoinNotificationActionFactoryImpl(this));<br> gms.addActionFactory(new FailureNotificationActionFactoryImpl(this));<br> if (memberToken != null &amp;&amp; memberToken.compareTo("server") != 0) </p> 
     <div class="error">
      <span class="error">Unknown macro: { gms.addActionFactory(serviceName, new FailureRecoveryActionFactoryImpl(this)); gms.addActionFactory(new MessageActionFactoryImpl(this), serviceName); }</span> 
     </div> <p>gms.addActionFactory(new JoinedAndReadyNotificationActionFactoryImpl(this));<br> }</p> <p>public void processNotification(Signal signal) </p> 
     <div class="error">
      <span class="error">Unknown macro: { .... /* process GMS signal notifications */ }</span> 
     </div> <p>Do we select one style or do we have to accomodate both styles in Glassfish v3.1 hk2?</p> <p>When a callback is registered, application dependent data is sometimes associated with the callback.<br> Would an GMS spefic annotation be needed to accomplish this in hk2, or is that functionality not available?</p> <p>Possible parameters for an annotation on a class found by hk2 that implements com.sun.enterprise.ee.cms.core.Callback.</p> <p>1. What GMS notifications should the callback be registered with?<br> Current GMS notifications include:</p> <p>GMS Membership Notifications: Join, JoinedAndreadReady, PlannedShutdown, FailureSuspected, Failure<br> GMS Cluster Event Notification: MessageActionFactory, GroupLeadership, FailureRecovery</p> <p>(Implementation detail: append "NotificationActionFactoryImpl" to all of the above when implementing in gms-adapter/GMSService)</p> <p>2. Which gms-group should the callback be registered with?<br> (a) ALL groups<br> (b) a specific gms-group</p> <p>3. Both FailureRecovery and Message notifications are registered by a componentName that is application specific.<br> This info would need to be communicated via an annotation or a new method added to interfaces for Message and RecoveryFailure Callbacks.</p> <p>See componentName javadoc for GroupManagementService.addActionFactory(String componentName, FailureRecoveryActionFactory)<br> and GroupManagementService.addActionFactory(MessageActionFactory, String componentName).</p> <p>4. Possible application data to be passed to the constructor of the class that implements com.sun.enterprise.ee.cms.core.Callback.<br> Minimally, it has been useful to have the memberToken name and gms-group name within Shoal GMS callback handlers.</p> <p>*********</p> <p>Add diagnostic utility to confirm that multicast is enabled between<br> a set of machines. This tool diagnoses one issue on why cluster members<br> may not be seeing each other. The tool only uses java MulticastSocket<br> and does not use GMS nor its transport. Name for tool and where it will live<br> are to be determined. Documentation is needed on when and how to use it.</p> <p>For GMS over Grizzly, this utility probably should be based on a generalized version of<br> com.sun.enterprise.mgmt.transport.BlockingIOMulticastSender.java.</p> <p>*********</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.5.2.PrivateInterfaces%3A"></a>4.5.2. Private Interfaces:</h4> <p>// List private interfaces which are externally observable.<br> Configuration within Glasfish v3.1 domain.xml element cluster and group-management-service elements.<br> See specification in <a href="http://wiki.glassfish.java.net/attach/V3FunctionalSpecs/gmsconfig_gfv3_1.rtf">http://wiki.glassfish.java.net/attach/V3FunctionalSpecs/gmsconfig_gfv3_1.rtf</a></p> <p>New module: cluster/gms-adapter // depends on shoal-gms-api.jar and shoal-gms-impl.jar<br> @Service<br> class GMSAdapterImpl implements GMSAdapter</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.5.3.Deprecated%2FRemovedInterfaces%3A"></a>4.5.3. Deprecated/Removed Interfaces:</h4> <p>// List existing public interfaces which will be deprecated or<br> // removed by this project.<br> NONE</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.6.DocImpact%3A"></a>4.6. Doc Impact:</h4> <p>// List any Documentation (man pages, manuals, service guides...)<br> // that will be impacted by this proposal.<br> Document new diagnosis utility to confirm that multicast is enabled on a subnet.<br> Assists in diagnosing why dynamic clustering is not working for a set of clustered instances.<br> When it is obvious that the clustered instances in a glassfish cluster are not seeing each other<br> (via analysis of GMS views in server log files), this utility should be run on each machine.<br> This utility assists in diagnosing if multicast is possible among the machines being used to<br> host the clustered instances.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.7.Admin%2FConfigImpact%3A"></a>4.7. Admin/Config Impact:</h4> <p>// How will this change impact the administration of the product?<br> // Identify changes to GUIs, CLI, agents, plugins...</p> <p>Changes are required for Admin GUI configuration of a cluster and group-management-service.<br> See <a href="http://wiki.glassfish.java.net/attach/V3FunctionalSpecs/gmsconfig_gfv3_1.rtf">http://wiki.glassfish.java.net/attach/V3FunctionalSpecs/gmsconfig_gfv3_1.rtf</a></p> <p>There is a need for being able to specify generic gms properties on both cluster and group-management-service level.<br> In Glassfish v2.1, there was no way to specify generic properties at the cluster level, only group-management-service level.<br> Thus, cluster properties could only be added via asadmin CLI set command in glassfish v2.x.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.8.HAImpact%3A"></a>4.8. HA Impact:</h4> <p>// What new requirements does this proposal place on the High<br> // Availability or Clustering aspects of the component?<br> None</p> <p>HA has requirements that GMS must meet.<br> Identified requirements are in this document.<br> There does exist a chance that other requirements are identified during implementation phase<br> given the relationship between HA and GMS.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.9.I18N%2FL10NImpact%3A"></a>4.9. I18N/L10N Impact:</h4> <p>no.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.10.Packaging%2CDelivery%26Upgrade%3A"></a>4.10. Packaging, Delivery &amp; Upgrade:</h4> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.10.1.Packaging"></a>4.10.1. Packaging</h4> <p>// What packages does this proposal impact? How will the packages<br> // be impacted? Will new IPS/pkg(5) packages need to be created?</p> <p>Not sure what a package is, but here is how Shoal GMS is integrated into Glassfish v3.1.</p> <p>Glassfish v3.1 module cluster/gms-adapter loads GMS and joins a glasfish clustered instance to its gms group.</p> <p>Shoal GMS is a sub project of Glassfish. The shoal gms module is<br> external source code that has its jar checked into Glassfish v3.1 via glassfish<br> maven repository.</p> <p>The Shoal GMS source code exist under a glassfish subproject on java.net.<br> Sources are located here:can be retrieved here.<br> svn checkout <a href="https://shoal.java.net/svn/shoal/branches/SHOAL_1_1_ABSTRACTING_TRANSPORT">https://shoal.java.net/svn/shoal/branches/SHOAL_1_1_ABSTRACTING_TRANSPORT</a> --username &lt;java.net.userid&gt;</p> <p>For the checked out source code, see pom.xml and directory gms, for Shoal GMS module.</p> <p>Final jar name: shoal-gms-1.5.jar. The updateable jar file is called shoal-gms-1.5-SNAPSHOT.jar.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.10.2.Delivery"></a>4.10.2. Delivery</h4> <p>// What impact will this proposal have on product installation?<br> The module will be installed as part of Glassfish install.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.10.3.UpgradeandMigration%3A"></a>4.10.3. Upgrade and Migration:</h4> <p>// What impact will this proposal have on product upgrade and/or<br> // migration from prior releases? Enumerate requirements this<br> // project has on upgrade and migration.</p> <p>Since clustering was not in Glassfish v3, there is no upgrade from v3 to v3.1.</p> <p>Upgrade from glassfish v2 clustering applications to glassfish v3.1 is needed.<br> This will consist of identifying glassfish v2 cluster and group-management-service elements in v2 domain.xml and<br> mapping to the glassfish v3.1 configuration. The gms configuration document captures what transformations<br> will need to be made.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.11.SecurityImpact%3A"></a>4.11. Security Impact:</h4> <p>// How does this proposal interact with security-related APIs<br> // or interfaces? Does it rely on any Java policy or platform<br> // user/permissions implication? If the feature exposes any<br> // new ports, Or any similar communication points which may<br> // have security implications, note these here.</p> <p>GMS using Grizzly ussing SSL is not in scope.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.12.CompatibilityImpact"></a>4.12. Compatibility Impact</h4> <p>// Incompatible changes to interfaces that others expect<br> // to be stable may cause other parts of application server or<br> // other dependent products to break.</p> <p>// Discuss changes to the imported or exported interfaces.<br> // Describe how an older version of the interface would<br> // be handled.<br> Missed GMS Notification of FAILURE when a clustered instance is restarted quicker than configured GMS heartbeat failure detection parameters.<br> In Glassfish v2.1.1, the Nodeagent was a GMS Watchdog that reported to GMS that a clustered instance had<br> failed.(Described in <a href="http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc">http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc</a>)<br> This was done since the Nodeagent was restarting the instance on some machine configurations quicker<br> than GMS heartbeat failure detection could report the instance had failed. By the time GMS was confirming a failure,<br> the clustered instance had been restarted (quicker than the default of 8 seconds it takes for GMS heartbeat failure<br> detection to confirm a failed instance.) For Glassfish v3.1, the GMS client is required to register<br> a JOIN and/or JOINED_AND_READY callback that check for the existence of the newly introduced subevent REJOIN.<br> When this subevent exists on a JOIN or JOINED_AND_READY notification, it indicates that the instance restarted<br> without a GMS notification that the instance had failed. The REJOIN subevent represents a recent FAILURE<br> of the clustered instance that is (re)JOIN the glassfish cluster. The INFO log event for GMS notification JOIN and JOINED_AND_READY<br> will have REJOIN in it, if there is a REJOIN element.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.13.Dependencies%3A"></a>4.13. Dependencies:</h4> <p>// List all dependencies that this proposal has on other<br> // proposals, components or products.<br> // LIST dependency component version requirements here.</p> <p>grizzly-framework.jar version 1.19.9-beta2 or higher (GMS code will not compile with 1.19.8 or lower)<br> grizzly-utils.jar version 1.19.9-beta2 or higher</p> <p>Admin GUI for ability to configure cluster and group-management-service properties.<br> asadmin CLI for setting domain.xml cluster and group-management-service attribute and properties.</p> <p>Depend on symbolic token replacement in domain.xml to set BIND_INTERFACE_ADDRESS different for each clustered instance.<br> $</p> 
     <div class="error">
      <span class="error">Unknown macro: {&lt;cluster-name&gt;-GMS_BIND_INTERFACE_ADDRESS}</span> 
     </div> <p>.</p> <p>Depend on existence of "asadmin start-cluster" to inject supplemental GMS behavior to call GroupManagmentService.announceGroupStartup()</p> <p>Distributed testing of GMS in GF v3.1 environment relies on remote starting/stopping of cluster and instances.<br> asadmin start-cluster, stop-cluster, start-instance, stop-instance.</p> <p>Subevent REJOIN of ADD event should be implemented by time that automatic restart of a failed clustered instance is in GF v3.1.</p> <p>Developer level testing of a cluster on one machine requires the ability to easily start multiple clustered instances on one machine.<br> In Glassfish v2.1, creating multiple instances on one machine resulted in each instance using different ports for HTTP, IIOP, ....<br> CONFIG-05 feature provides this.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-4.14.TestingImpact"></a>4.14. Testing Impact</h4> <p>// How will the new feature(s) introduced by this project be tested?<br> REJOIN -<br> A SHOAL GMS developer unit level test is already written that will cause a REJOIN to occur.<br> The JOIN and JOIN_AND_READY ShoalLogger INFO log event should mention REJOIN subevent when it exists.</p> <p>Existing scenarios from gf v2.1 gms with kill of a clustered instance will need to change its log analysis to verify REJOIN.<br> The REJOIN will only be testable in Glassfish v3.1 platform when native OS restart of application server is implemented<br> and appropriate instructions to activate that property are followed (if there are any)<br> (REJOIN replaces NodeAgent WATCHDOG from gf v2.1.1. Since NodeAgent is not implemented, NodeAgent WATCHDOG no longer will work in<br> GF v3.1)</p> <p>********</p> <p>New method previousAliveAndReadyMembers().<br> A new Shoal GMS developer unit level test will be written to verify new method GroupHandle.previousAliveAndReadyMembers().<br> The test will verify that this method is working properly by starting up a cluster, ensuring it is at steady state<br> and then verify that this method returns the proper list after GMS client has join or left the cluster.<br> For Glassfish QE distributed Shoal testing, the scenario needs to verify what this method returns when the<br> in a steady state glassfish cluster after the following operations cause a change in a running glassfish cluster that has reached steady state.</p> <p>(1) start instance via "asadmin start-instance)<br> (2) PLANNED_SHUTDOWN of single clustered instance<br> (3) FAILURE detection of a failed instance. (4) restart of an instance in glassfish v3.1 (via it being registered as a native OS service)</p> <p>Note: no testable constraints exist for this method during cluster startup (asadmin CLI start-cluster),<br> during cluster shutdown (asadmin CLI stop-cluster), when multiple events (starts/stops) happen exactly at same time.</p> <p>********</p> <p>// Do tests exist from prior releases (e.g. v2) that can be reused?<br> Yes. Shoal QE Scenario test scenarios can be reused. Adjustments may need to be made to<br> accommodate differences between v2 and v3.1. (i.e. NodeAgent not existing in v3.1, potentially<br> minor changes to asadmin CLI to manage glassfish cluster starting/stopping, ...)<br> These changes will amount to fairly small changes to scripts that run scenarios and<br> changes to what log events to look for in certain situations. However, the testing methodology<br> used to test in v2 will work equally well in v3.1.</p> <p>// Will new tests need to be written? Can they be automated?<br> New tests to be written were listed above and initial thoughts on testing were mentioned.<br> It should be possible to automate running the tests but manual investigation of log files of failures<br> will be needed.</p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-5.ReferenceDocuments%3A"></a>5. Reference Documents:</h4> <p>// List of related documents, if any (BugID's, RFP's, papers).<br> // Explain how/where to obtain the documents, and what each<br> // contains, not just their titles.</p> <p>See GMS configuration in Glassfish v3.1: <a href="http://wiki.glassfish.java.net/PageInfo.jsp?page=GlassFishv3.1GMS/gmsconfig_gfv3_1.rtf">http://wiki.glassfish.java.net/PageInfo.jsp?page=GlassFishv3.1GMS/gmsconfig_gfv3_1.rtf</a></p> <p>Shoal GMS over Grizzly distributed unit QE testing (by Kazem)<br> <a href="http://wikihome.sfbay.sun.com/glassfish/Wiki.jsp?page=ShoalGrizzlyTestScenarios">http://wikihome.sfbay.sun.com/glassfish/Wiki.jsp?page=ShoalGrizzlyTestScenarios</a></p> <p>Following page contains Milestone functionalities.<br> Glassfish v3.1 GMS subproject page: <a href="./GlassFishv3.1GMS.html">http://wiki.glassfish.java.net/Wiki.jsp?page=GlassFishv3.1GMS</a></p> <p>Reference GMS Configuration in Glassfish v3.1 document here. Describes GMS configuration in domain.xml.</p> <p>Stop-gap clustering distributed test harness (from Steve D.)<br> % export CVSROOT=:pserver:&lt;sunLDAPID&gt;@redcvs.red.iplanet.com:/m/jws<br> % cvs co appserver-sqe/ee/gms/sm<br> See appserver-sqe/ee/gms/sm/README.txt</p> <p>Glassfish v2.1.1 functionality not being implemented in Glassfish v3.1 since Nodeagent is not part of GF v3.1.<br> GMS Watchdog functionality ensured that a clustered instance that is quickly restarted (less than 8 secs) is<br> still reported as a GMS FAILURE. gf v2.1.1 details described in<br> See: <a href="http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc">http://wiki.glassfish.java.net/attach/SFv2FunctionalSpecs/gmsWatchdog.doc</a></p> <h4><a name="GlassFish_v3.1_GMS_One_Pager-6.Schedule%3A"></a>6. Schedule:</h4> <h4><a name="GlassFish_v3.1_GMS_One_Pager-6.1.ProjectedAvailability%3A"></a>6.1. Projected Availability:</h4> 
     <ul> 
      <li>Initially integrated (may not be feature complete) M2<br> Before M2. Hopefully before end of May. Stop-gap clustering test harness enable earlier testing.<br> Being held up by task to only load shoal-1.5.jar<br> if cluster gms-enabled is true.</li> 
     </ul> 
     <ul> 
      <li>Feature complete (ready for handoff to QA) M4</li> 
     </ul> 
     <ul> 
      <li>At production quality level: Final Release</li> 
     </ul> <h4><a name="GlassFish_v3.1_GMS_One_Pager-Relationships"></a>Relationships</h4> <p>clustered instance belongs to one glassfish cluster.<br> standalone instance belongs to a gms group. <b>new</b> design on how this appears in GMS config outstanding.<br> DAS belongs to 0 to many glassfish clusters.</p> <p>Given above relationships, original implementation of GMSAdapterImpl (formerly called GMSService)<br> was one to one relationship with GMS group. Is it possible to have more than one<br> GMSAdapter, one per glassfish cluster that DAS belongs to.</p> <p>GMS client lifecycle</p> 
     <ul class="alternate" type="square"> 
      <li>join called once when GF app server instance joins GMS group</li> 
     </ul> 
     <ul class="alternate" type="square"> 
      <li>reportJoinedAndReady - should be called when EventTypes.SERVER_READY occurs. (if that is when server is ready<br> for incoming client traffic.)</li> 
     </ul> 
     <ul class="alternate" type="square"> 
      <li>shutdown called when receive EventTypes.SERVER_SHUTDOWN occurs.</li> 
     </ul> <p>TBD: Access to GMS in DAS with more than one cluster.</p> </td> 
   </tr> 
  </tbody>
 </table>    
</body></div>
        <br/>

        <!-- footer================================================== -->
        <footer class="well">
            <div class="container">

                <div class="row-fluid" id="bottom-info">
                    <!--div class="span6 pagination-centered" id="social"-->
                    <div class="span4" id="social">			
                        <a href="http://blogs.oracle.com/theaquarium/"><img src="../images/icons/TheAquarium.png"></a>
                        <a href="https://twitter.com/glassfish"><img src="../images/icons/twitter.png"></a>
                        <a href="https://plus.google.com/communities/106098646151660933759"><img src="../images/icons/google.png"></a>
                        <a href="http://www.linkedin.com/groups/GlassFish-Users-106819/about"><img src="../images/icons/linkedin.png"></a>
                        <a href="http://www.youtube.com/user/GlassFishVideos"><img src="../images/icons/youtube.png"></a>
                        <a href="https://www.facebook.com/GlassFish"><img src="../images/icons/facebook.png"></a>
                    </div>

                    <div class="span8" id="copyright">Page last changed on Aug 28, 2012 by 
<font color="#0050B2">10193</font>. Exported from wikis.oracle.com on May 27, 2015 20:46.<br/>
                        Copyright &copy; 2005-2015 Oracle Corporation and/or its affiliates.</div>
                </div>
            </div>
        </footer>

        <!-- ================================================== -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/bootstrap-tab.js"></script>
	<script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<!--  Begin SiteCatalyst code  -->
  	<!--  End SiteCatalyst code  -->
    </body>
</html>